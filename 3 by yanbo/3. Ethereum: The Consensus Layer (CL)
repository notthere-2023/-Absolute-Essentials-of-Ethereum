# 第三章 以太坊：共识层

*烟波*

---

由于以太坊是去中心化的，所以没有中心化机构可以决定世界计算机的现状，即所谓的世界状态。世界状态映射的用户账户地址称为外部账户（EOA），应用程序账户则称为合约账户。为了跟踪世界状态，以太坊使用了区块链和安全的记录保存系统，实现在互不认识或互不信任的用户之间的分散协调。以太坊的区块链被称为*Beacon Chain*，它有自己的状态，即信标状态也必须过渡。为了实现状态转换，区块链具有共识机制。

共识机制是区块链使用的激励协议，用于就某一事态达成一致。在以太坊中，共识机制被称为 "赌注证明（PoS）"或 "盯盘"。非正式地讲，验证者需要投入32个ETH的赌注，以获得参与协商一致的权利。每隔12秒，在一个时段内，一个选择验证器来提出一个代表状态转换的块（世界状态、灯塔状态）。然后由审定委员会投票/证明区块的合法性。验证者因其参与认捐，但行为不端会导致失去认捐的资金ETH。因此，验证者既有动力诚实地更新以太坊，并抑制不诚实的行为。当所有运行时隙都产生一个转换并被记录在块数据结构中。

一旦一个区块最终确定，它就会成为正统的历史记录，无法还原。

**区块和区块链**

让我们从一个高层次的视角开始，了解区块和区块链。

以太坊区块链包含哪些内容？区块是包含区块链上下文信息的数据结构。它是以太坊在某个时间点的快照。一个区块可以成为区块链中的最新区块，即区块链（见图3.1）。

在增设这个区块之前，之前的一个区块已经通过验收，并且是最近的一个区块。在此之前，还有一个区块。这些区块相互堆叠，一直到以太坊的原创世纪0号区块于2015年7月30日完成。所有这些区块累计起来，永久记录了在以太坊上发生的活动。区块链分布在所有全节点参与者之间，而不是位于一个地方。请记住，我们没有一个中央权威机构可以更新世界计算机，这意味着我们没有一个实体可以添加下一个区块。相反，共识机制确保所有全节点都拥有相同的区块链历史记录，并使区块链可以扩展新的区块。

因为没有中心化机构，区块链还具有防篡改性，这意味着任何人都不能单方面更改历史记录。一旦一种状态被接受后，就不能再恢复。现在，让我们来看看人们可能会攻击区块链并试图改变它，但在正确的操作下，区块链是不可变的。最后，区块链是透明的，这意味着在区块链上发生的所有活动都是完全公开的。这是分散式网络的副作用。每个节点都需要一份区块链副本，因为我们都在密切关注确保每个人都遵循共识机制协议，不滥用系统。

这个概念一开始可能有些难以理解，但实际上并不存在单一的区块链存储在世界某个角落的情况。相反，每个以太坊网络中的完整节点都会保存一份区块链。在以太坊中，主要有三种类型的节点：全节点、存档和轻量级。我们称运行完整节点的用户为节点操作员。

全节点由软件执行客户端和共识器组成。执行客户端的选项包括 Geth、Nethermind、Besu 和Erigon。协商一致的客户端选项包括 Prysm、Teku、Lighthouse、Nimbus 和 Lodestar。使用多种选项被称为客户端多样性，其目的是确保在一个客户端发现的任何问题不会影响整个网络。完整节点可以独立验证交易、世界状态和区块链。这是因为他们拥有区块链的“完整”副本。我说“完整”，因为大多数全节点软件都会对区块链进行修剪。随着

修剪，会保留一定深度的区块，但只保留历史数据的快照。这些区块可以根据需要（很少）再生。许多独立用户、公司和服务选择运行全节点，以拥有最完整的区块链信息。存档节点是一个完整节点，包含区块链的完整历史，并且不进行修剪。归档节点对存储空间的要求很高，因此这些资源实际上只适合纯粹主义者。最后，在轻量级节点（有时也称为轻客户端）依赖于全节点，以获取有关区块链的信息。还有一个实体，被称为验证者，负责通过定桩共识机制更新区块链。

**权益证明（PoS）或者称为赌注证明**

在接下来的七年时间里（2015年至2022年），以太坊使用了相同的工作证明（PoW）或者挖矿共识机制，与比特币相同，但是也有一些变化。挖矿让用户竞相更新区块链，通过参与计算竞赛，找出谜题的解决方案。这种设计导致了一场意想不到的军备竞赛，使得采矿业变得越来越专业化，普通用户无法参与，而只有专家和工业企业才能参与。这是因为采矿需要使用定制的机器，这些机器被称为专用集成电路（ASIC）。ASIC对能源的需求量非常大，而比特币因此在主流社会中赢得了“环境问题”的名声。

不过，我鼓励读者自己研究采矿问题，特别是在比特币社区的许多人一直在努力解决这个问题。无论如何，最好采用权益证明机制。以太坊社区认为这是因为没有定制的机器，因此参与更容易达成共识。以太坊在2019年从挖矿过渡到了权益证明。

在2022年9月，通过一项名为“合并”的活动，以太坊成功地将能源消耗率降低了99.95%。合并是一项重大工程，需要从采矿实时切换到权益证明，开发人员功不可没，一切顺利。

**验证节点**

要了解验证节点，我们需要从以下角度入手：

质押人。当我们泛泛地谈论参与下列活动的个人时，我们称他们为验证节点。例如，superphiz.eth 就是以太坊社区中一个著名的验证节点。验证节点参与共识机制。验证节点是一个账户将32个以太坊存入存款合约作为抵押（赌注）。

要成为验证者，staker必须是全节点操作员，即执行和达成共识，然后使用验证器客户端选择加入押金。存款合同是参与验证者的合同账户列表，有一个验证者队列以确保网络不会超载。32个ETH的赌注非常重要，因为它可以确保Sybil阻力。在区块链背景下，我们不希望恶意实体能够无成本地启动验证节点，即Sybils。真正的ETH必须是由于以太坊的自我防御机制，攻击者可能会失去这些数据。一旦验证器不在队列中，就会加入验证器集合。作为该集合的一部分，验证器的工作是决定当前区块链的头并最终完成区块。第一项任务是通过最新的消息驱动贪婪算法决定的，即最重观测子树（LMD GHOST）投票。

这符合区块的添加速度很快的特性。第二个任务是使用卡斯珀友好终结器来决定区块的终结，即小工具（Casper- FFG）投票。Casper- FFG的投票分为两个部分，最终定稿（论证和定稿）和区块链中的历史点。这满足了最终性的属性，其中我们可以保证达到某一点的区块是永久性的。这意味着总共有三张选票：head of the

chain, justification and finalisation。在作为一个单元进行讨论时，LMD GHOST和Casper- FFG组合成为Gasper。校验器在一个时间段内工作，该时间段分为时段和时间。LMD GHOST的投票发生在一个插槽中，而Casper- FFG的投票发生在另一个插槽中，发生在不同的时间段（图3.2）。

时长：  12秒。

Epoch：  32 个时段长或大约 6.4 分钟。

***Slots*和 *LMD GHOST***

首先，让我们关注一下*Slots*。*Slots*是一个持续 12 秒的时间窗口，在这个窗口中，区块可以被提名为区块链的最新负责人。在每个*Slots*中，一个区块会随机抽取一名提议者作为领导者。只有一名验证者被指定为该时段的整体提议者。区块建议者的选择提前使用一种名为 RANDAO 的伪随机算法。如果区块提议者不提议，则该区块有可能是空的，但一般来说，大多数*Slots*都会被填满。被选中提出一个区块是一件比较罕见的事情。区块提议者的工作包括四个方面。首先，他们回顾上一个*Slots*，并找出前一个区块中证明最多、"最重"的区块。其次，他们构建一个新的信标区块，其中包含上下文信息，如进入和退出验证器、处罚错误验证器等，这将使以太坊过渡到一个新的 Beacon 状态。第三，在执行客户端中，它们通过以下方式转换世界状态：从内存池中收集事务，并在 EVM 中执行，最终以执行块的形式产生执行有效载荷。最后，他们在区块上签名，然后将其提交给验证者以进行证明。不过，他们并没有将其提交给整个验证程序集。

那么，除了区块提议者，还有哪些验证者呢？在大多数情况下，验证器的作用是证明所涉及的问题，就像投票一样。证明的结果根据验证者的余额进行加权（稍后详述）。

第一个证明是 LMD GHOST 投给最新提议区块的证明。这次投票与验证器分配给的特定插槽有关，即由委员会（也使用 RANDAO 进行选择）指定的验证器组成的小组，为验证插槽中的建议程序块而指定的验证器。委员会是由在存款合同中的一组验证者组成的，每个纪元中，验证器随机分布在委员会的 32 个名额中的一个。例如，目前约有 703,000 名有效验证员分布在 219,146 个纪元中。这意味着每个时隙将有约 22,000 名委员会成员。如果我们看看其中一个纪元的第 7,012,687 个时隙，我们会发现有 21,908 个证明验证人。***Slots***委员会中的审定人签署区块建议者提出的建议。实际上，他们是在证明拟议过渡的有效性。

由于该区块的证明文件最多，因此***Slots***将建在该区块上。

图3.3 LMD GHOST

如果***Slots***为空，可能是因为指定的区块提议者离线了，那么委员会将投票支持前一个区块，因为最晚还会有剩余。还有一个同步委员会，它为轻型客户提供服务的验证员进行选择（参见图3.3）。

***Epochs和Casper*FFG**

验证者进行的第二项验证，即卡斯帕-FFG表决，比较笼统，确实是两票。与卡斯帕-FFG不同，验证者证明有两个检查点。检查点是在纪元的开始。如果该时段没有区块，则前一个区块成为检查点。第一个检查点是目标，指当前纪元开始时的检查点。第二个检查点是源点，指纪元中的检查点优先。如果目标检查点获得2/3的超级多数票，那么它就变成了有理。如果来源，即先前的有理目标区块一旦获得2/3的超级多数票，就会最终确定。一旦区块被确定，它们将被视为以太坊的永久组成部分，且无法还原。我在关于恶意分叉和攻击的章节中详细介绍了2/3的重要性在超级多数中，诚然（参见图3.4）。
